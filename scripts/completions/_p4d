#compdef p4dev

# P4dev ZSH completion script

_p4dev_commands() {
  local -a commands
  commands=(
    'list:List all active tmux sessions'
    'sessions:Show available sessions from config'
    'edit:Edit the configuration file'
    'help:Show help message'
  )
  _describe 'command' commands
}

_p4dev_configured_sessions() {
  local -a sessions
  local config_file="$HOME/.config/p4dev/sessions.yaml"
  
  # If the config file exists and yq is available, extract session names
  if [[ -f "$config_file" ]] && command -v yq >/dev/null 2>&1; then
    sessions=(${(f)"$(yq eval 'keys | .[]' "$config_file" 2>/dev/null)"})
  else
    # Fallback to common session names if config not available
    sessions=(
      'mapper:Mapper project session'
      'dayjob:Day job development session'
      'learning:Learning and experiments session'
      'sideproject:Side project session'
      'quickstart:Quick development session'
    )
  fi
  
  _describe 'configured sessions' sessions
}

_p4dev_active_sessions() {
  local -a sessions
  sessions=(${(f)"$(tmux list-sessions 2>/dev/null | cut -d: -f1)"})
  _describe 'active sessions' sessions
}

_p4dev() {
  local curcontext="$curcontext" state line ret=1
  
  _arguments -C \
    '(--help -h)'{-h,--help}'[Show help message]' \
    '(--config -c)'{-c,--config}'[Use alternative config file]:config file:_files' \
    '(--kill -k)'{-k,--kill}'[Kill session instead of attaching]' \
    '1: :->commands' \
    '*::args:->args' && ret=0
  
  case $state in
    commands)
      # Handle both session names and commands
      _alternative \
        'sessions:configured sessions:_p4dev_configured_sessions' \
        'commands:commands:_p4dev_commands' && ret=0
      ;;
    args)
      case $line[1] in
        list|sessions|edit|help)
          # These commands don't take additional arguments
          ;;
        *)
          # For kill mode with -k flag, suggest active sessions
          if [[ ${words[@]} =~ (-k|--kill) ]]; then
            _p4dev_active_sessions && ret=0
          else
            _p4dev_configured_sessions && ret=0
          fi
          ;;
      esac
      ;;
  esac
  
  return ret
}

_p4dev "$@"
